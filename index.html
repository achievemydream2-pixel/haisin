<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GITADORA 抽選システム (完全同期・整合性保証版)</title>

<style>
body {
  margin: 0;
  background: #0a0a19;
  background: url("背景画像URL") no-repeat center/cover;
  font-family: "Segoe UI", "Meiryo", sans-serif;
  display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden;
}

.container {
  width: 1200px; padding: 50px; background: rgba(10, 10, 25, 0.98);
  border-radius: 40px; border: 3px solid rgba(255, 255, 255, 0.2);
  color: #fff; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.8);
}

.song {
  font-size: 58px; font-weight: bold; min-height: 90px; margin-bottom: 20px;
  color: #00f2ff; text-shadow: 0 0 20px rgba(0, 242, 255, 0.6);
  word-wrap: break-word; display: flex; align-items: center; justify-content: center;
}

.meta {
  font-size: 42px; opacity: 0.9; height: 50px; margin-bottom: 50px;
  border-bottom: 2px solid rgba(255,255,255,0.1); padding-bottom: 20px;
}

button {
  font-size: 40px; padding: 22px 100px; border-radius: 999px; border: none;
  cursor: pointer; font-weight: bold; color: #fff;
  background: linear-gradient(135deg, #ff4d6d, #ff9f1c);
  transition: transform 0.1s, box-shadow 0.2s;
  box-shadow: 0 8px 25px rgba(255, 77, 109, 0.5);
}

button:hover:not(:disabled) { transform: scale(1.05); box-shadow: 0 12px 35px rgba(255, 77, 109, 0.7); }
button:active:not(:disabled) { transform: scale(0.95); }
button:disabled { background: #444; opacity: 0.6; cursor: default; box-shadow: none; }
</style>
</head>

<body>
<div class="container">
  <div class="song" id="song">READY...</div>
  <div class="meta" id="meta">Lv.9.50以上</div>
  <button id="btn" onclick="draw()">Select Start!</button>
</div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbyLLE6PNo8AXUzAzY3FlcLt9KzYk2hUa_ChQmcw0drNQkQ5x4ue6vYD6A7C1ABYXd_W7g/exec";

// 自分専用の識別ID
const MY_CLIENT_ID = "ID_" + Date.now() + "_" + Math.random().toString(36).substring(2, 11);

let animTimer = null;
let lastTime = null;
let lastStartTime = null; 
let isDrawing = false;
let isFirstLoad = true;

function startAnimation() {
  const dummy = ["ちんこ", "まんこ", "クンニ", "おちんちん", "おっぱい", "アナル", "カニバイブ";]
  let i = 0;
  if (animTimer) clearInterval(animTimer);
  animTimer = setInterval(() => {
    document.getElementById("song").textContent = dummy[i++ % dummy.length];
    document.getElementById("meta").textContent = "抽選中...";
  }, 80);
}

function stopAnimation() {
  if (animTimer) clearInterval(animTimer);
  animTimer = null;
}

function showResult(data) {
  const formattedLv = data.level ? Number(data.level).toFixed(2) : "0.00";
  document.getElementById("song").textContent = data.title || "No Title";
  document.getElementById("meta").textContent = 
    data.part ? `${data.part} / Lv.${formattedLv}` : `Lv.${formattedLv}`;
}

// ボタンを押した本人の処理
async function draw() {
  if (isDrawing) return; 
  isDrawing = true; 
  const btn = document.getElementById("btn");
  btn.disabled = true;

  startAnimation();
  const requestTime = Date.now();

  try {
    const res = await fetch(`${GAS_URL}?action=draw&clientId=${MY_CLIENT_ID}&t=${requestTime}`);
    const result = await res.json();

    if (result.startTime) {
      lastStartTime = String(result.startTime);
      lastTime = result.time;

      // 演出時間を消化
      const elapsedTime = Date.now() - requestTime;
      const waitTime = Math.max(0, 7000 - elapsedTime); 

      setTimeout(() => {
        stopAnimation();
        showResult(result);
        setTimeout(() => {
          isDrawing = false; 
          btn.disabled = false;
        }, 1500); 
      }, waitTime);
    }
  } catch (e) {
    stopAnimation();
    isDrawing = false;
    btn.disabled = false;
  }
}

// 他人の動作を検知する同期処理
async function fetchResult() {
  if (isDrawing) return;

  try {
    const res = await fetch(`${GAS_URL}?action=get&t=${Date.now()}`);
    const data = await res.json();

    // 初回読み込み（READY...維持）
    if (isFirstLoad) {
      lastStartTime = String(data.startTime);
      lastTime = data.time;
      isFirstLoad = false; 
      return; 
    }

    // 新しい開始IDを検知
    if (data.startTime && String(data.startTime) !== String(lastStartTime)) {
      
      // 自分の実行なら無視
      if (data.clientId === MY_CLIENT_ID) {
        lastStartTime = String(data.startTime);
        lastTime = data.time;
        return; 
      }

      // 他人の抽選：演出開始
      lastStartTime = String(data.startTime);
      if (!animTimer) {
        startAnimation();
        
        // 【重要】演出が終わる直前（7秒後）に「確定した曲データ」を再取得する
        setTimeout(async () => {
          try {
            const finalRes = await fetch(`${GAS_URL}?action=get&t=${Date.now()}`);
            const finalData = await finalRes.json();
            stopAnimation();
            showResult(finalData); // 最新の曲を表示
            lastTime = finalData.time;
          } catch (e) {
            stopAnimation();
            showResult(data); // 失敗時は元のデータ
          }
        }, 7000);
      }
    } 
  } catch (e) {
    console.warn("Sync Skip");
  }
}

fetchResult();
setInterval(fetchResult, 1000);
</script>
</body>
</html>












